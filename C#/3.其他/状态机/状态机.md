# 状态机

#### 有限状态机

一种用来进行对象行为建模的工具

主要描述对象在它的生命周期内所经历的状态序列，以及如何响应来自外界的各种事件



#### 状态机要素

1.状态：当前所处的状态

2.条件(事件)：触发一个动作，执行一次状态的迁移

3.动作：条件满足后执行的动作

4.次态：条件满足后要迁往的新状态



#### 状态机例

- **订单状态**

  ​              购物车结算                                 点击支付                                      支付成功

  购物车       →       订单已生成Pending       →       支付处理中Processing       →       交易已成功Completed

  ​                                      ↓买家取消                           支付失败↓↑重新支付                              ↓买家退货

  ​                              订单已取消Cancelled               交易已失败Declined                       已退单Return

  | 现态       | 条件                         | 动作              | 次态                  |
  | ---------- | ---------------------------- | ----------------- | --------------------- |
  | 订单已生成 | 购物车非空，用户点击结算     | 点击支付          | 支付处理中            |
  | 订单已取消 | 订单合法，买家取消           | -                 | -                     |
  | 支付处理中 | 订单合法，第三方处理支付     | 支付失败/支付成功 | 交易已失败/交易已成功 |
  | 交易已失败 | 第三方收付款失败             | 重新支付          | 支付处理中            |
  | 交易已成功 | 第三方收付款成功             | 买家退货          | 已退单                |
  | 已退单     | 订单合法，验货成功，买家退货 | -                 | -                     |

  ```c#
  // OrderStateEnum 对应了订单的现态
  public enum OrderStateEnum
  { 
      Pending,  //订单已生成
      Processing, // 支付处理中
      Completed, // 交易成功
      Declined, // 交易失败
      Cancelled, // 订单取消
      Refund // 已退款
  }
  
  // OrderStateTriggerEnum 对应了触发下一个状态的订单的动作
  public enum OrderStateTriggerEnum
  {
      PlaceOrder, // 支付
      Approve, // 支付成功
      Reject, // 支付失败
      Cancel, // 取消
      Return // 退货
  }
  ```

  
